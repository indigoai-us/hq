name: Build Installers

on:
  release:
    types: [created]

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install NSIS
        run: choco install nsis -y

      - name: Create placeholder assets
        shell: pwsh
        run: |
          $assetsDir = "installer/windows/assets"

          # Create minimal .ico files if not present (32x32 blank)
          foreach ($icon in @("hq-icon.ico", "hq-uninstall.ico")) {
            if (-not (Test-Path "$assetsDir/$icon")) {
              # Create a minimal 16x16 ICO file (header + 1 entry + 32-bit BITMAPINFOHEADER + pixel data)
              $bytes = [byte[]]@(
                0,0,1,0,1,0,  # ICO header: reserved, type=1(icon), count=1
                16,16,0,0,1,0,32,0,  # Entry: 16x16, 0 colors, 0 reserved, 1 plane, 32bpp
                0x68,4,0,0,  # Size of image data (1128 bytes)
                0x16,0,0,0   # Offset to image data
              )
              # BITMAPINFOHEADER (40 bytes)
              $bmpHeader = [byte[]]@(
                40,0,0,0,    # biSize
                16,0,0,0,    # biWidth
                32,0,0,0,    # biHeight (2x for ICO)
                1,0,         # biPlanes
                32,0,        # biBitCount
                0,0,0,0,     # biCompression
                0,4,0,0,     # biSizeImage
                0,0,0,0,     # biXPelsPerMeter
                0,0,0,0,     # biYPelsPerMeter
                0,0,0,0,     # biClrUsed
                0,0,0,0      # biClrImportant
              )
              # Pixel data (16x16x4 = 1024 bytes) + AND mask (16x2 = 64 bytes, padded)
              $pixels = [byte[]]::new(1024 + 64)
              # Fill with a blue-ish color (BGRA)
              for ($i = 0; $i -lt 1024; $i += 4) {
                $pixels[$i] = 0xC8     # B
                $pixels[$i+1] = 0x78   # G
                $pixels[$i+2] = 0x3C   # R
                $pixels[$i+3] = 0xFF   # A
              }
              $allBytes = $bytes + $bmpHeader + $pixels
              [System.IO.File]::WriteAllBytes("$assetsDir/$icon", $allBytes)
            }
          }

          # Create minimal BMP files if not present
          foreach ($bmp in @("welcome-banner.bmp", "header.bmp")) {
            if (-not (Test-Path "$assetsDir/$bmp")) {
              # Create a 1x1 white BMP
              $bmpBytes = [byte[]]@(
                0x42,0x4D,          # BM signature
                0x3E,0,0,0,         # File size (62 bytes)
                0,0,0,0,            # Reserved
                0x3E,0,0,0,         # Pixel data offset
                0x28,0,0,0,         # DIB header size (40)
                1,0,0,0,            # Width: 1
                1,0,0,0,            # Height: 1
                1,0,                # Color planes: 1
                24,0,               # Bits per pixel: 24
                0,0,0,0,            # Compression: none
                4,0,0,0,            # Image size
                0x13,0x0B,0,0,      # X pixels per meter
                0x13,0x0B,0,0,      # Y pixels per meter
                0,0,0,0,            # Colors in table
                0,0,0,0,            # Important colors
                0xFF,0xFF,0xFF,0x00 # White pixel + padding
              )
              [System.IO.File]::WriteAllBytes("$assetsDir/$bmp", $bmpBytes)
            }
          }

      - name: Compile NSIS installer
        shell: cmd
        run: |
          "C:\Program Files (x86)\NSIS\makensis.exe" /DBUNDLED_TEMPLATE installer\windows\hq-installer.nsi

      - name: Upload installer to release
        uses: softprops/action-gh-release@v2
        with:
          files: installer/windows/hq-setup-*.exe

  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Import signing certificate
        env:
          MACOS_CERTIFICATE_BASE64: ${{ secrets.MACOS_CERTIFICATE_BASE64 }}
          MACOS_CERTIFICATE_PASSWORD: ${{ secrets.MACOS_CERTIFICATE_PASSWORD }}
        run: |
          if [ -z "$MACOS_CERTIFICATE_BASE64" ]; then
            echo "No signing certificate configured, skipping"
            exit 0
          fi

          security create-keychain -p "" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "" build.keychain

          echo "$MACOS_CERTIFICATE_BASE64" | base64 --decode > certificate.p12
          security import certificate.p12 -k build.keychain \
            -P "$MACOS_CERTIFICATE_PASSWORD" \
            -T /usr/bin/codesign \
            -T /usr/bin/productsign
          security set-key-partition-list \
            -S apple-tool:,apple:,productsign: \
            -s -k "" build.keychain

          rm certificate.p12

      - name: Build macOS installer
        env:
          SIGNING_IDENTITY: ${{ secrets.MACOS_SIGNING_IDENTITY }}
        run: |
          cd installer/macos
          chmod +x build-pkg.sh
          if [ -n "$SIGNING_IDENTITY" ]; then
            ./build-pkg.sh "$SIGNING_IDENTITY"
          else
            ./build-pkg.sh
          fi

      - name: Notarize package
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          APPLE_APP_PASSWORD: ${{ secrets.APPLE_APP_PASSWORD }}
        run: |
          if [ -z "$APPLE_ID" ]; then
            echo "No Apple ID configured, skipping notarization"
            exit 0
          fi

          xcrun notarytool submit installer/macos/build/*.pkg \
            --apple-id "$APPLE_ID" \
            --team-id "$APPLE_TEAM_ID" \
            --password "$APPLE_APP_PASSWORD" \
            --wait

          xcrun stapler staple installer/macos/build/*.pkg

      - name: Upload installer to release
        uses: softprops/action-gh-release@v2
        with:
          files: installer/macos/build/hq-*.pkg
