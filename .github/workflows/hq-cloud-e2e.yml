# HQ Cloud E2E Testing Workflow
#
# Runs Playwright E2E tests for the HQ Cloud web app on every push
# or pull request that changes packages/hq-cloud/.
#
# Two tiers:
#   1. Fast suite (mock-based): Runs on every push, no secrets needed.
#      Uses E2E_MOCK_ONLY=true so API calls are intercepted via page.route().
#   2. Full suite (Clerk auth): Runs when E2E_TEST_EMAIL secret is set.
#      Tests real Clerk sign-in, smoke, auth flow, and sync tests.
#
# ECS-based session tests are excluded (too slow/expensive for CI).
# Run those manually via workflow_dispatch.
#
# Required secrets (for full suite only):
#   NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY - Clerk publishable key
#   CLERK_SECRET_KEY                  - Clerk secret key
#   E2E_TEST_EMAIL                    - Test account email
#   E2E_TEST_PASSWORD                 - Test account password

name: HQ Cloud E2E

on:
  push:
    paths:
      - "packages/hq-cloud/**"
  pull_request:
    branches: [main]
    paths:
      - "packages/hq-cloud/**"
  workflow_dispatch:
    inputs:
      run_full_suite:
        description: "Run full suite (Clerk auth tests) even if secrets are not configured"
        required: false
        default: "false"
        type: boolean

concurrency:
  group: hq-cloud-e2e-${{ github.ref }}
  cancel-in-progress: true

env:
  PNPM_VERSION: "8.14.0"
  NODE_VERSION: "20"
  HQ_CLOUD_DIR: packages/hq-cloud
  WEB_DIR: packages/hq-cloud/web
  API_DIR: packages/hq-cloud/api

jobs:
  # ============================================
  # Check if secrets are configured
  # ============================================
  check-secrets:
    name: Check Secrets
    runs-on: ubuntu-latest
    outputs:
      has-clerk-secrets: ${{ steps.check.outputs.has_secrets }}
    steps:
      - name: Check for E2E secrets
        id: check
        env:
          E2E_EMAIL: ${{ secrets.E2E_TEST_EMAIL }}
        run: |
          if [ -n "$E2E_EMAIL" ]; then
            echo "has_secrets=true" >> $GITHUB_OUTPUT
            echo "E2E_TEST_EMAIL secret is configured"
          else
            echo "has_secrets=false" >> $GITHUB_OUTPUT
            echo "E2E_TEST_EMAIL secret is NOT configured - full suite will be skipped"
          fi

  # ============================================
  # Fast Suite: Mock-based E2E tests
  # ============================================
  e2e-mock:
    name: "E2E: Mock-based (fast)"
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "pnpm"
          cache-dependency-path: ${{ env.HQ_CLOUD_DIR }}/pnpm-lock.yaml

      - name: Install dependencies
        working-directory: ${{ env.HQ_CLOUD_DIR }}
        run: pnpm install --frozen-lockfile

      - name: Install Playwright browsers
        working-directory: ${{ env.WEB_DIR }}
        run: npx playwright install --with-deps chromium

      - name: Run mock-based E2E tests
        id: test-mock
        working-directory: ${{ env.WEB_DIR }}
        env:
          CI: "true"
          E2E_MOCK_ONLY: "true"
          # Clerk keys needed for clerkSetup() in global-setup.ts
          # even in mock-only mode (Clerk middleware runs server-side).
          # Fall back to placeholder values if secrets aren't configured --
          # mock-only tests intercept all API calls via page.route() anyway.
          NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: ${{ secrets.NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY || 'pk_test_placeholder' }}
          CLERK_SECRET_KEY: ${{ secrets.CLERK_SECRET_KEY || 'sk_test_placeholder' }}
        run: |
          npx playwright test 2>&1 | tee test-output.txt
          echo "exit_code=${PIPESTATUS[0]}" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Generate test summary
        if: always()
        working-directory: ${{ env.WEB_DIR }}
        run: |
          echo "## HQ Cloud E2E: Mock-based Suite" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f test-results/results.json ]; then
            TOTAL=$(jq '[.suites[].specs[]] | length' test-results/results.json 2>/dev/null || echo "?")
            PASSED=$(jq '[.suites[].specs[].tests[].results[] | select(.status == "passed")] | length' test-results/results.json 2>/dev/null || echo "?")
            FAILED=$(jq '[.suites[].specs[].tests[].results[] | select(.status == "failed")] | length' test-results/results.json 2>/dev/null || echo "?")
            SKIPPED=$(jq '[.suites[].specs[].tests[].results[] | select(.status == "skipped")] | length' test-results/results.json 2>/dev/null || echo "?")

            echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| Total | $TOTAL |" >> $GITHUB_STEP_SUMMARY
            echo "| Passed | $PASSED |" >> $GITHUB_STEP_SUMMARY
            echo "| Failed | $FAILED |" >> $GITHUB_STEP_SUMMARY
            echo "| Skipped | $SKIPPED |" >> $GITHUB_STEP_SUMMARY
          else
            echo "No JSON results found. Check test-output.txt artifact." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-mock-report
          path: ${{ env.WEB_DIR }}/playwright-report/
          retention-days: 7
          if-no-files-found: ignore

      - name: Upload test results (JSON + screenshots)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-mock-results
          path: |
            ${{ env.WEB_DIR }}/test-results/
            ${{ env.WEB_DIR }}/test-output.txt
          retention-days: 7
          if-no-files-found: ignore

      - name: Fail if tests failed
        if: steps.test-mock.outputs.exit_code != '0'
        run: |
          echo "Mock-based E2E tests failed with exit code ${{ steps.test-mock.outputs.exit_code }}"
          exit 1

  # ============================================
  # Full Suite: Clerk-authenticated E2E tests
  # ============================================
  e2e-full:
    name: "E2E: Clerk auth (full)"
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [check-secrets, e2e-mock]
    # Only run if Clerk test secrets are configured (checked via job output)
    if: needs.check-secrets.outputs.has-clerk-secrets == 'true'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "pnpm"
          cache-dependency-path: ${{ env.HQ_CLOUD_DIR }}/pnpm-lock.yaml

      - name: Install dependencies
        working-directory: ${{ env.HQ_CLOUD_DIR }}
        run: pnpm install --frozen-lockfile

      - name: Install Playwright browsers
        working-directory: ${{ env.WEB_DIR }}
        run: npx playwright install --with-deps chromium

      - name: Create API .env for E2E
        working-directory: ${{ env.API_DIR }}
        env:
          CLERK_SK: ${{ secrets.CLERK_SECRET_KEY }}
          CLERK_PK: ${{ secrets.NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY }}
        run: |
          cat > .env <<EOF
          PORT=3001
          HOST=0.0.0.0
          NODE_ENV=test
          CLERK_SECRET_KEY=${CLERK_SK}
          CLERK_PUBLISHABLE_KEY=${CLERK_PK}
          MONGODB_URI=mongodb://localhost:27017/hq-cloud-test
          AWS_REGION=us-east-1
          S3_BUCKET=hq-cloud-test
          EOF

      - name: Run full E2E tests
        id: test-full
        working-directory: ${{ env.WEB_DIR }}
        env:
          CI: "true"
          NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: ${{ secrets.NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY }}
          CLERK_SECRET_KEY: ${{ secrets.CLERK_SECRET_KEY }}
          E2E_TEST_EMAIL: ${{ secrets.E2E_TEST_EMAIL }}
          E2E_TEST_PASSWORD: ${{ secrets.E2E_TEST_PASSWORD }}
          E2E_TEST_EMAIL_B: ${{ secrets.E2E_TEST_EMAIL_B }}
          E2E_TEST_PASSWORD_B: ${{ secrets.E2E_TEST_PASSWORD_B }}
        run: |
          npx playwright test 2>&1 | tee test-output.txt
          echo "exit_code=${PIPESTATUS[0]}" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Generate test summary
        if: always()
        working-directory: ${{ env.WEB_DIR }}
        run: |
          echo "## HQ Cloud E2E: Full Suite (Clerk Auth)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f test-results/results.json ]; then
            TOTAL=$(jq '[.suites[].specs[]] | length' test-results/results.json 2>/dev/null || echo "?")
            PASSED=$(jq '[.suites[].specs[].tests[].results[] | select(.status == "passed")] | length' test-results/results.json 2>/dev/null || echo "?")
            FAILED=$(jq '[.suites[].specs[].tests[].results[] | select(.status == "failed")] | length' test-results/results.json 2>/dev/null || echo "?")
            SKIPPED=$(jq '[.suites[].specs[].tests[].results[] | select(.status == "skipped")] | length' test-results/results.json 2>/dev/null || echo "?")

            echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| Total | $TOTAL |" >> $GITHUB_STEP_SUMMARY
            echo "| Passed | $PASSED |" >> $GITHUB_STEP_SUMMARY
            echo "| Failed | $FAILED |" >> $GITHUB_STEP_SUMMARY
            echo "| Skipped | $SKIPPED |" >> $GITHUB_STEP_SUMMARY
          else
            echo "No JSON results found. Check test-output.txt artifact." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-full-report
          path: ${{ env.WEB_DIR }}/playwright-report/
          retention-days: 7
          if-no-files-found: ignore

      - name: Upload test results (JSON + screenshots)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-full-results
          path: |
            ${{ env.WEB_DIR }}/test-results/
            ${{ env.WEB_DIR }}/test-output.txt
          retention-days: 7
          if-no-files-found: ignore

      - name: Fail if tests failed
        if: steps.test-full.outputs.exit_code != '0'
        run: |
          echo "Full E2E tests failed with exit code ${{ steps.test-full.outputs.exit_code }}"
          exit 1

  # ============================================
  # PR Comment: Post test summary
  # ============================================
  pr-comment:
    name: Post PR Comment
    runs-on: ubuntu-latest
    needs: [e2e-mock, e2e-full]
    if: github.event_name == 'pull_request' && always()
    permissions:
      pull-requests: write

    steps:
      - name: Download mock results
        uses: actions/download-artifact@v4
        with:
          name: e2e-mock-results
          path: mock-results
        continue-on-error: true

      - name: Download full results
        uses: actions/download-artifact@v4
        with:
          name: e2e-full-results
          path: full-results
        continue-on-error: true

      - name: Post PR comment
        uses: actions/github-script@v7
        env:
          MOCK_STATUS: ${{ needs.e2e-mock.result }}
          FULL_STATUS: ${{ needs.e2e-full.result }}
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            const mockStatus = process.env.MOCK_STATUS;
            const fullStatus = process.env.FULL_STATUS;
            const runId = context.runId;
            const repo = `${context.repo.owner}/${context.repo.repo}`;

            const statusIcon = (s) => {
              if (s === 'success') return ':white_check_mark:';
              if (s === 'failure') return ':x:';
              if (s === 'skipped') return ':fast_forward:';
              return ':grey_question:';
            };

            // Parse JSON results if available
            function parseResults(dir) {
              try {
                const jsonPath = path.join(dir, 'test-results', 'results.json');
                if (!fs.existsSync(jsonPath)) return null;
                const data = JSON.parse(fs.readFileSync(jsonPath, 'utf8'));
                const specs = data.suites?.flatMap(s => s.specs) || [];
                const total = specs.length;
                const tests = specs.flatMap(s => s.tests || []);
                const results = tests.flatMap(t => t.results || []);
                const passed = results.filter(r => r.status === 'passed').length;
                const failed = results.filter(r => r.status === 'failed').length;
                const skipped = results.filter(r => r.status === 'skipped').length;
                return { total, passed, failed, skipped };
              } catch {
                return null;
              }
            }

            const mockResults = parseResults('mock-results');
            const fullResults = parseResults('full-results');

            let body = `## HQ Cloud E2E Test Results\n\n`;
            body += `| Suite | Status | Details |\n`;
            body += `|-------|--------|---------|\n`;

            if (mockResults) {
              body += `| Mock-based (fast) | ${statusIcon(mockStatus)} ${mockStatus} | ${mockResults.passed}/${mockResults.total} passed`;
              if (mockResults.failed > 0) body += `, ${mockResults.failed} failed`;
              body += ` |\n`;
            } else {
              body += `| Mock-based (fast) | ${statusIcon(mockStatus)} ${mockStatus} | - |\n`;
            }

            if (fullStatus !== 'skipped') {
              if (fullResults) {
                body += `| Clerk auth (full) | ${statusIcon(fullStatus)} ${fullStatus} | ${fullResults.passed}/${fullResults.total} passed`;
                if (fullResults.failed > 0) body += `, ${fullResults.failed} failed`;
                body += ` |\n`;
              } else {
                body += `| Clerk auth (full) | ${statusIcon(fullStatus)} ${fullStatus} | - |\n`;
              }
            } else {
              body += `| Clerk auth (full) | :fast_forward: skipped | No E2E_TEST_EMAIL secret configured |\n`;
            }

            body += `\n**Workflow run:** [#${runId}](https://github.com/${repo}/actions/runs/${runId})\n\n`;

            // Add artifact download instructions on failure
            if (mockStatus === 'failure' || fullStatus === 'failure') {
              body += `<details>\n<summary>Download failure artifacts</summary>\n\n`;
              body += `\`\`\`bash\n`;
              body += `# Download HTML reports\n`;
              body += `gh run download ${runId} -R ${repo} -n e2e-mock-report\n`;
              if (fullStatus === 'failure') {
                body += `gh run download ${runId} -R ${repo} -n e2e-full-report\n`;
              }
              body += `\n# Download screenshots and traces\n`;
              body += `gh run download ${runId} -R ${repo} -n e2e-mock-results\n`;
              if (fullStatus === 'failure') {
                body += `gh run download ${runId} -R ${repo} -n e2e-full-results\n`;
              }
              body += `\`\`\`\n`;
              body += `</details>\n\n`;
            }

            body += `---\n_Generated by HQ Cloud E2E workflow_`;

            // Find and update or create comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(c =>
              c.user.type === 'Bot' &&
              c.body.includes('HQ Cloud E2E Test Results')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body,
              });
            }
