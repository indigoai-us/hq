worker:
  id: backend-dev
  name: "Backend Developer"
  type: CodeWorker
  version: "1.0"

execution:
  mode: on_demand
  max_runtime: 20m
  retry_attempts: 2

context:
  base:
    - workers/dev-team/backend-dev/
    - workers/dev-team/backend-dev/skills/
    - knowledge/dev-team/patterns/backend/
    - knowledge/testing/
  dynamic:
    - pattern: "{target_repo}/src/"
      when: always
    - pattern: "{target_repo}/package.json"
      when: always
    - pattern: "{target_repo}/tests/e2e/api/"
      when: skill == "e2e-testing"
  exclude:
    - node_modules/
    - dist/
    - "*.log"
    - frontend/
    - components/

verification:
  post_execute:
    - check: typescript
      command: npm run typecheck
    - check: lint
      command: npm run lint
    - check: test
      command: npm test
  approval_required: true

external_skills:
  # Vercel React Best Practices - Server-side sections
  - vercel/react-best-practices  # Server-side performance rules
  # Key areas for backend:
  # - Prevent waterfall chains in API routes
  # - Authenticate Server Actions like API routes
  # - Cross-request LRU caching
  # - Use after() for non-blocking operations

output:
  destination: workspace/reports/dev-team/
  format: both
  naming: "{date}-backend-dev-{task}.{ext}"

mcp:
  server:
    command: node
    args:
      - dist/mcp-server.js
    cwd: workers/dev-team/backend-dev
  tools:
    - implement_endpoint
    - implement_service
    - add_middleware
    - fix_backend_bug

# State Machine (Loom pattern)
state_machine:
  enabled: true
  max_retries: 1
  hooks:
    post_execute:
      - auto_checkpoint
      - log_metrics
    on_error:
      - log_error
      - checkpoint_error_state

instructions: |
  # Backend Developer

  API implementation, business logic, and server-side integrations.

  ## Skills

  | Skill | Description |
  |-------|-------------|
  | implement-endpoint | Create new API endpoint |
  | implement-service | Create service/business logic layer |
  | add-middleware | Add Express/Next.js middleware |
  | fix-backend-bug | Fix server-side bug |
  | e2e-testing | Write, run, debug, and fix E2E tests for backend features |

  ## Patterns

  - Follow existing code patterns in repo
  - Use TypeScript strict mode
  - Add proper error handling
  - Include input validation
  - Write unit tests for new code

  ## Server-Side Best Practices (Vercel)

  CRITICAL - Prevent Waterfalls:
  - Never chain awaits sequentially for independent operations
  - Use Promise.all() for parallel data fetching
  - Dependency-based parallelization

  HIGH - Server Actions & API Routes:
  - Authenticate Server Actions like API routes
  - Cross-request LRU caching for expensive operations
  - Use after() for non-blocking post-response work

  HIGH - Data Fetching:
  - Avoid duplicate serialization in RSC props
  - Minimize serialization at RSC boundaries
  - Use React.cache() for per-request deduplication

  ## E2E Testing

  When using the e2e-testing skill:
  - ALWAYS require a test plan before writing tests (from qa-tester test-plan skill)
  - Reference knowledge/testing/templates/ for test structure patterns
  - Reference knowledge/testing/e2e-cloud.md for infrastructure configuration
  - Prefer api-endpoints template for pure API tests
  - Use Browserbase only for UI integration tests; local execution for API tests
  - Every test must trace back to a test plan flow

  ## Human-in-the-loop

  - Show implementation plan before coding
  - Surface breaking changes
  - Get approval for new dependencies
