{
  "name": "hq-cloud-worker-runtime",
  "description": "Containerized worker execution environment with ECS Fargate orchestration",
  "branchName": "feature/hq-cloud-worker-runtime",
  "parentProject": "hq-cloud",
  "userStories": [
    {
      "id": "WRT-001",
      "title": "Worker container base image",
      "description": "As the system, I want a Docker image with Claude CLI and HQ tools so that workers can execute",
      "acceptanceCriteria": [
        "Dockerfile based on Node 20 Alpine",
        "Claude CLI installed and configured",
        "HQ directory structure present",
        "Environment variables for API connection",
        "Image builds successfully and is < 500MB"
      ],
      "priority": 1,
      "passes": false,
      "labels": ["infrastructure", "docker", "phase-2"],
      "dependsOn": [],
      "notes": "Foundation for all worker execution"
    },
    {
      "id": "WRT-002",
      "title": "Worker bootstrap script",
      "description": "As a container, I want to register with the API on startup so that I can receive commands",
      "acceptanceCriteria": [
        "On container start, call POST /api/workers/register",
        "Send container ID, worker type, capabilities",
        "Establish WebSocket connection to API",
        "Handle registration failure gracefully",
        "Heartbeat loop started"
      ],
      "priority": 1,
      "passes": false,
      "labels": ["runtime", "phase-2"],
      "dependsOn": ["WRT-001"],
      "notes": ""
    },
    {
      "id": "WRT-003",
      "title": "ECS Fargate task definition",
      "description": "As the orchestrator, I want an ECS task definition so that I can spawn worker containers",
      "acceptanceCriteria": [
        "Task definition with worker image",
        "CPU/memory limits configured (0.5 vCPU, 1GB RAM default)",
        "IAM role with S3 access for file sync",
        "VPC networking configured",
        "Environment variables passed from spawn request"
      ],
      "priority": 1,
      "passes": false,
      "labels": ["infrastructure", "aws", "phase-2"],
      "dependsOn": ["WRT-001"],
      "notes": ""
    },
    {
      "id": "WRT-004",
      "title": "Worker spawner service",
      "description": "As the API, I want to spawn worker containers on demand so that users can run workers",
      "acceptanceCriteria": [
        "Service consumes spawn queue from API-007",
        "Calls ECS RunTask API",
        "Tracks task ARN in worker registry",
        "Handles spawn failures with retry",
        "Returns container status to API"
      ],
      "priority": 1,
      "passes": true,
      "labels": ["orchestration", "phase-2"],
      "dependsOn": ["WRT-003"],
      "notes": "Completes API-007 integration"
    },
    {
      "id": "WRT-005",
      "title": "Claude CLI wrapper with event streaming",
      "description": "As a worker container, I want to run Claude CLI and stream events so that the API can track progress",
      "acceptanceCriteria": [
        "Wrapper script invokes Claude CLI with worker config",
        "Parses Claude output for status events",
        "Streams events to API via WebSocket",
        "Captures questions/prompts and sends to API",
        "Handles CLI exit codes"
      ],
      "priority": 2,
      "passes": true,
      "labels": ["runtime", "phase-2"],
      "dependsOn": ["WRT-002"],
      "notes": "Core execution loop"
    },
    {
      "id": "WRT-006",
      "title": "Question blocking and resume",
      "description": "As a worker, I want to pause for user input and resume when answered so that I can be unblocked",
      "acceptanceCriteria": [
        "When Claude prompts for input, worker pauses",
        "Question sent to API with options if available",
        "Worker status updated to waiting_input",
        "WebSocket listener for answer events",
        "On answer received, pipe to Claude stdin and resume"
      ],
      "priority": 2,
      "passes": true,
      "labels": ["runtime", "realtime", "phase-2"],
      "dependsOn": ["WRT-005"],
      "notes": "Critical for remote control use case"
    },
    {
      "id": "WRT-007",
      "title": "Worker graceful shutdown",
      "description": "As a container, I want to shut down gracefully so that work is not lost",
      "acceptanceCriteria": [
        "SIGTERM handler installed",
        "Current operation allowed to complete (with timeout)",
        "Final status sent to API",
        "Checkpoint written if supported",
        "Container exits cleanly"
      ],
      "priority": 2,
      "passes": true,
      "labels": ["runtime", "phase-2"],
      "dependsOn": ["WRT-002"],
      "notes": ""
    },
    {
      "id": "WRT-008",
      "title": "Worker logs streaming",
      "description": "As a user, I want to see worker logs so that I can debug issues",
      "acceptanceCriteria": [
        "Container stdout/stderr captured",
        "Logs streamed to CloudWatch",
        "API endpoint to fetch logs: GET /api/workers/:id/logs",
        "Optional WebSocket streaming for live tail",
        "Log retention policy configured"
      ],
      "priority": 3,
      "passes": true,
      "labels": ["observability", "phase-2"],
      "dependsOn": ["WRT-004"],
      "notes": ""
    },
    {
      "id": "WRT-009",
      "title": "Worker auto-termination",
      "description": "As the system, I want idle workers to terminate so that we don't waste resources",
      "acceptanceCriteria": [
        "Configurable idle timeout (default 15 min)",
        "Heartbeat tracking in orchestrator",
        "Workers without activity terminated",
        "Final status captured before termination",
        "Cost savings metrics logged"
      ],
      "priority": 3,
      "passes": true,
      "labels": ["orchestration", "cost", "phase-2"],
      "dependsOn": ["WRT-004"],
      "notes": ""
    },
    {
      "id": "WRT-010",
      "title": "Worker resource scaling configuration",
      "description": "As a user, I want to configure worker resources so that complex tasks get more power",
      "acceptanceCriteria": [
        "Spawn request accepts resource tier parameter",
        "Tiers: small (0.5 vCPU/1GB), medium (1 vCPU/2GB), large (2 vCPU/4GB)",
        "Task definition templates per tier",
        "Default tier configurable per worker type"
      ],
      "priority": 3,
      "passes": true,
      "labels": ["orchestration", "phase-2"],
      "dependsOn": ["WRT-003"],
      "notes": ""
    }
  ],
  "metadata": {
    "createdAt": "2026-02-05T12:00:00Z",
    "goal": "Containerized worker execution with cloud orchestration",
    "successCriteria": "Workers spawn in ECS, execute Claude CLI, stream status, and handle questions",
    "qualityGates": ["pnpm typecheck && pnpm lint && pnpm test"],
    "repoPath": "packages/hq-cloud/worker-runtime",
    "relatedWorkers": ["backend-dev", "infra-dev", "architect"],
    "knowledge": []
  }
}
