{
  "name": "hq-cloud-core-api",
  "description": "Central API gateway with WebSocket support for real-time worker communication and orchestration",
  "branchName": "feature/hq-cloud-core-api",
  "parentProject": "hq-cloud",
  "userStories": [
    {
      "id": "API-001",
      "title": "Project scaffolding with TypeScript + pnpm workspace",
      "description": "As a developer, I want a monorepo structure so that all hq-cloud packages share tooling and dependencies",
      "acceptanceCriteria": [
        "pnpm workspace configured at packages/hq-cloud/",
        "Shared tsconfig.json with strict mode",
        "ESLint + Prettier configured",
        "packages/hq-cloud/api/ exists with basic Express/Fastify setup",
        "pnpm typecheck passes"
      ],
      "priority": 1,
      "passes": true,
      "labels": ["infrastructure", "phase-1"],
      "dependsOn": [],
      "notes": "Foundation for all other work"
    },
    {
      "id": "API-002",
      "title": "WebSocket server with connection management",
      "description": "As a client, I want to establish a persistent WebSocket connection so that I receive real-time updates",
      "acceptanceCriteria": [
        "WebSocket endpoint at /ws",
        "Connection registry tracks connected clients by deviceId",
        "Heartbeat/ping-pong keeps connections alive",
        "Graceful disconnect handling",
        "Unit tests for connection lifecycle"
      ],
      "priority": 1,
      "passes": true,
      "labels": ["api", "realtime", "phase-1"],
      "dependsOn": ["API-001"],
      "notes": "Implemented with @fastify/websocket, InMemoryConnectionRegistry, heartbeat timer"
    },
    {
      "id": "API-003",
      "title": "Authentication with API keys",
      "description": "As a user, I want to authenticate my devices so that only I can access my workers",
      "acceptanceCriteria": [
        "API key generation endpoint",
        "API key validation middleware",
        "Keys stored securely (hashed)",
        "Rate limiting per key",
        "Device registration with key"
      ],
      "priority": 1,
      "passes": false,
      "labels": ["security", "phase-1"],
      "dependsOn": ["API-001"],
      "notes": "Simple API keys for MVP, can add OAuth later"
    },
    {
      "id": "API-004",
      "title": "Worker registry data model",
      "description": "As the system, I want to track registered workers so that I can route messages to them",
      "acceptanceCriteria": [
        "Worker model: id, name, status, containerId, registeredAt, lastHeartbeat",
        "DynamoDB table for workers (or Postgres if preferred)",
        "CRUD operations for workers",
        "Status enum: pending, running, waiting_input, completed, failed"
      ],
      "priority": 1,
      "passes": true,
      "labels": ["data", "phase-1"],
      "dependsOn": ["API-001"],
      "notes": "Implemented with in-memory store (InMemoryWorkerStore) with WorkerRegistry interface for easy swap to DynamoDB/Postgres later"
    },
    {
      "id": "API-005",
      "title": "Worker status streaming endpoint",
      "description": "As a mobile user, I want to see worker status updates in real-time so that I know what's happening",
      "acceptanceCriteria": [
        "GET /api/workers returns list with current status",
        "WebSocket broadcasts status changes to subscribed clients",
        "Client can subscribe to specific worker or all workers",
        "Status includes: current task, progress (e.g., 4/6), last activity"
      ],
      "priority": 2,
      "passes": true,
      "labels": ["api", "realtime", "phase-1"],
      "dependsOn": ["API-002", "API-004"],
      "notes": "Maps to Agents list screen in Figma. Implemented with subscribe/unsubscribe WS messages, worker change callbacks, and extended Worker model with currentTask, progress, lastActivity fields."
    },
    {
      "id": "API-006",
      "title": "Worker question/answer routing",
      "description": "As a worker, I want to send questions to users so that I can get unblocked",
      "acceptanceCriteria": [
        "POST /api/workers/:id/questions - worker submits question",
        "Question model: id, workerId, text, options[], answeredAt, answer",
        "WebSocket pushes new question to subscribed clients immediately",
        "POST /api/workers/:id/questions/:qid/answer - client answers",
        "Answer routed back to worker container"
      ],
      "priority": 2,
      "passes": true,
      "labels": ["api", "realtime", "phase-1"],
      "dependsOn": ["API-002", "API-004"],
      "notes": "Implemented with Question model (id, workerId, text, options[], status, createdAt, answeredAt, answer), InMemoryQuestionStore with callback system for answer routing, WebSocket broadcasts for new questions and answered events, worker status auto-update to waiting_input/running"
    },
    {
      "id": "API-007",
      "title": "Worker spawn request endpoint",
      "description": "As a user, I want to request a worker to start so that it runs in the cloud",
      "acceptanceCriteria": [
        "POST /api/workers/spawn - request new worker",
        "Request body: workerId, skill, parameters",
        "Validates worker exists in HQ registry",
        "Returns pending worker with tracking ID",
        "Queues spawn request for orchestrator"
      ],
      "priority": 2,
      "passes": false,
      "labels": ["api", "orchestration", "phase-1"],
      "dependsOn": ["API-003", "API-004"],
      "notes": "Actual spawning handled by worker-runtime sub-project"
    },
    {
      "id": "API-008",
      "title": "Chat history endpoint",
      "description": "As a mobile user, I want to see the full conversation with a worker so that I have context",
      "acceptanceCriteria": [
        "GET /api/workers/:id/chat returns message history",
        "Messages stored with timestamp, role (worker/user/system), content",
        "Pagination support for long conversations",
        "New messages broadcast via WebSocket"
      ],
      "priority": 3,
      "passes": true,
      "labels": ["api", "phase-1"],
      "dependsOn": ["API-004"],
      "notes": "Maps to Agent Details screen in Figma. Implemented with ChatMessage model (id, workerId, role, content, timestamp, metadata), InMemoryChatStore with cursor-based pagination (before/after), POST /api/workers/:id/chat for creating messages, GET for listing with pagination, WebSocket broadcast via chat_message event type. 21 tests added."
    },
    {
      "id": "API-009",
      "title": "Push notification integration",
      "description": "As a mobile user, I want push notifications when a worker needs input so that I don't miss questions",
      "acceptanceCriteria": [
        "Device token registration endpoint",
        "Integration with AWS SNS or Firebase",
        "Push sent when question posted and no active WebSocket",
        "Push payload includes question preview"
      ],
      "priority": 3,
      "passes": true,
      "labels": ["mobile", "notifications", "phase-1"],
      "dependsOn": ["API-006"],
      "notes": "Implemented with PushProvider abstraction (MockPushProvider for dev, stubs for AwsSnsPushProvider and FirebasePushProvider), DeviceTokenStore for token registration, POST /api/push/tokens endpoint, push sent async when question posted to devices without active WebSocket, payload includes worker name and question preview. 26 tests added."
    },
    {
      "id": "API-010",
      "title": "Health checks and observability",
      "description": "As an operator, I want health endpoints and logging so that I can monitor the system",
      "acceptanceCriteria": [
        "GET /health returns service status",
        "Structured JSON logging",
        "Request tracing with correlation IDs",
        "CloudWatch metrics integration",
        "Error alerting configured"
      ],
      "priority": 3,
      "passes": false,
      "labels": ["infrastructure", "observability", "phase-1"],
      "dependsOn": ["API-001"],
      "notes": ""
    }
  ],
  "metadata": {
    "createdAt": "2026-02-05T12:00:00Z",
    "goal": "Central API for worker orchestration and real-time client communication",
    "successCriteria": "Clients can connect via WebSocket, see worker status, and answer questions",
    "qualityGates": ["pnpm typecheck && pnpm lint && pnpm test"],
    "repoPath": "packages/hq-cloud/api",
    "relatedWorkers": ["backend-dev", "architect", "infra-dev"],
    "knowledge": []
  }
}
