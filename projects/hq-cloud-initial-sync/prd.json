{
  "name": "hq-cloud-initial-sync",
  "description": "Automatic initial HQ-to-S3 sync when users log in via CLI, Indigo Docs app, or HQ Cloud web — with fail protection and retry.",
  "branchName": "feature/hq-cloud",
  "userStories": [
    {
      "id": "US-001",
      "title": "API: Setup status endpoint",
      "description": "As a client (CLI, web, docs app), I want a GET /api/auth/setup-status endpoint that returns whether the authenticated user has completed initial sync, so all channels can check setup state consistently.",
      "acceptanceCriteria": [
        "GET /api/auth/setup-status returns { setupComplete: boolean, s3Prefix: string|null, fileCount: number }",
        "setupComplete is true only when hq_user_settings.s3Prefix is set AND at least 1 file exists in S3 under that prefix",
        "Returns 401 for unauthenticated requests",
        "Works with both Clerk JWT (web) and CLI token auth",
        "Unit tests cover all response cases"
      ],
      "priority": 1,
      "passes": false,
      "labels": ["api", "auth"],
      "dependsOn": [],
      "notes": "This is the single source of truth for all three channels. Avoids each client implementing its own check logic."
    },
    {
      "id": "US-002",
      "title": "API: Provision S3 prefix on first auth",
      "description": "As a new user, I want my S3 prefix to be automatically provisioned when I first authenticate, so the storage path is ready before I try to sync.",
      "acceptanceCriteria": [
        "When a user authenticates for the first time (no hq_user_settings doc exists), create the settings doc with s3Prefix set to '{clerkUserId}/hq/'",
        "When an existing user has s3Prefix: null, set it to '{clerkUserId}/hq/' on next authentication",
        "The clerkUserId already starts with 'user_' — do NOT double-prefix",
        "Provisioning is idempotent — calling it multiple times doesn't change an existing s3Prefix",
        "Unit tests verify provisioning for new users and backfill for existing users with null s3Prefix"
      ],
      "priority": 1,
      "passes": false,
      "labels": ["api", "auth", "mongodb"],
      "dependsOn": [],
      "notes": "Root cause fix: s3Prefix was null because it was never set during the original onboarding. This ensures it's always set."
    },
    {
      "id": "US-003",
      "title": "API: Fix file upload for empty and large files",
      "description": "As a user syncing HQ files, I want empty files (like .gitkeep) to upload successfully and large files to be handled gracefully, so the initial sync doesn't report avoidable errors.",
      "acceptanceCriteria": [
        "Empty files (0 bytes) are uploaded to S3 as zero-byte objects instead of returning 'content is required' error",
        "Files exceeding the body size limit (currently ~1MB) return a clear error message with the file name and size",
        "API route /api/files/upload accepts an optional 'allowEmpty: true' flag or treats empty content as valid",
        "Fastify body size limit is increased to 10MB for the upload route (or use multipart/presigned URLs for larger files)",
        "Unit tests cover empty file upload, large file upload, and error messages"
      ],
      "priority": 2,
      "passes": false,
      "labels": ["api", "files"],
      "dependsOn": [],
      "notes": "Known errors from sync: '.gitkeep: content is required', '.jpeg: Request body is too large'. These caused 19 of 1132 files to fail."
    },
    {
      "id": "US-004",
      "title": "CLI: Auto-detect setup status after login",
      "description": "As a CLI user, after I run 'hq auth login' and authenticate successfully, I want the CLI to automatically check if initial sync is needed and prompt me to start it, so I don't have to know about 'hq sync push' separately.",
      "acceptanceCriteria": [
        "After successful 'hq auth login', CLI calls GET /api/auth/setup-status",
        "If setupComplete is false, CLI prints 'Initial sync needed. Starting upload of your HQ files...' and begins sync automatically",
        "If setupComplete is true, CLI prints 'HQ Cloud is set up and synced ({fileCount} files).'",
        "If the setup-status check fails (network error), CLI prints warning but login still succeeds",
        "User can skip auto-sync with --no-sync flag on the login command"
      ],
      "priority": 1,
      "passes": false,
      "labels": ["cli", "auth", "sync"],
      "dependsOn": ["US-001"],
      "notes": "This is the main CLI channel entry point. The sync should feel like part of the login flow, not a separate step."
    },
    {
      "id": "US-005",
      "title": "CLI: Resilient initial sync with progress and retry",
      "description": "As a CLI user performing initial sync, I want to see progress, get a clear summary of results, and be offered retry on failure, so I know the sync worked without needing to debug.",
      "acceptanceCriteria": [
        "Initial sync shows a progress bar or counter: 'Uploading files... (342/1132)'",
        "After sync completes, shows summary: 'Synced 1113 files. 19 skipped (see details with --verbose).'",
        "Failure is defined as: 0 files successfully uploaded (total failure). Partial success (>50% uploaded) is considered success with warnings",
        "On total failure: print error message and prompt 'Retry initial sync? (Y/n)'",
        "On partial failure (<50% success): print warning and prompt 'Some files failed. Retry failed files? (Y/n)'",
        "Skipped files (empty .gitkeep, oversized binaries) are logged but do not count as failures",
        "A --verbose flag shows individual file errors"
      ],
      "priority": 2,
      "passes": false,
      "labels": ["cli", "sync", "ux"],
      "dependsOn": ["US-003", "US-004"],
      "notes": "User specifically requested fail protection with retry. The threshold for 'failure' vs 'partial success' prevents false alarms when a few files are skipped."
    },
    {
      "id": "US-006",
      "title": "HQ Cloud Web: Auto-detect setup on login",
      "description": "As a user logging into HQ Cloud web (app.hq.getindigo.ai), I want the app to check if initial sync has been done and show me a setup prompt if not, so I can initiate sync from the web UI.",
      "acceptanceCriteria": [
        "After Clerk authentication, web app calls GET /api/auth/setup-status",
        "If setupComplete is false, show a setup banner/modal: 'Your HQ files haven't been synced yet. Set up sync to access your files, navigator, and more.'",
        "Banner offers two options: 'Sync via CLI' (shows `hq auth login` command) and 'Upload from browser' (future, disabled for MVP with tooltip 'Coming soon')",
        "If setupComplete is true, proceed to normal dashboard without any banner",
        "Banner is dismissible but reappears on next login if setup still incomplete",
        "Setup status is cached in React state for the session (no repeated API calls on navigation)"
      ],
      "priority": 2,
      "passes": false,
      "labels": ["web", "auth", "ux"],
      "dependsOn": ["US-001"],
      "notes": "For MVP, web channel detects the issue and directs user to CLI. Browser-based upload can be added later. The important thing is the user isn't confused by an empty Navigator."
    },
    {
      "id": "US-007",
      "title": "Indigo Docs App: Auto-detect setup on login",
      "description": "As a user logging into the Indigo Docs desktop app, I want it to check if initial sync has been done and guide me to set up if needed, so all three channels provide a consistent setup experience.",
      "acceptanceCriteria": [
        "After authentication, docs app calls GET /api/auth/setup-status (using stored auth token)",
        "If setupComplete is false, show a setup notification: 'HQ Cloud sync not set up. Run `hq auth login` in your terminal to sync your HQ files.'",
        "If setupComplete is true, docs app proceeds normally",
        "Notification is non-blocking (user can still use the app)",
        "The check only runs once per app launch, not on every navigation"
      ],
      "priority": 3,
      "passes": false,
      "labels": ["docs-app", "auth", "ux"],
      "dependsOn": ["US-001"],
      "repoPath": "C:\\repos\\hq-docs-app",
      "branchName": "feature/initial-sync-detection",
      "notes": "Indigo Docs app (hq-docs-app) is a Tauri desktop app in a SEPARATE repo (indigoai-us/hq-docs-app). For MVP it just detects and notifies — actual sync happens via CLI."
    },
    {
      "id": "US-008",
      "title": "API: Remove server-side walkDirectory from initial-sync",
      "description": "As a developer, I want to remove the server-side walkDirectory-based initial sync logic that doesn't work in production ECS, replacing it with the client-push model that already works.",
      "acceptanceCriteria": [
        "Remove or deprecate performInitialSync() in data/initial-sync.ts that uses walkDirectory()",
        "The initial sync flow is: client scans local files → client pushes to /api/files/upload → API stores in S3",
        "No server-side code attempts to read the local filesystem for sync purposes",
        "The setup-status endpoint (US-001) replaces the old 'check if synced' logic",
        "Existing file-proxy.ts upload/download/list operations remain unchanged"
      ],
      "priority": 2,
      "passes": false,
      "labels": ["api", "cleanup"],
      "dependsOn": ["US-001", "US-002"],
      "notes": "The current initial-sync.ts walks the server filesystem which doesn't work in ECS Fargate. The CLI push model (hq sync push) already works correctly."
    }
  ],
  "metadata": {
    "createdAt": "2026-02-19T12:00:00Z",
    "goal": "Provide seamless automatic initial HQ file sync when users log in via CLI, web, or docs app — with clear progress, fail protection, and retry capability",
    "successCriteria": "A new user can run 'hq auth login' and have their HQ files automatically synced to S3 without any additional manual steps. Navigator shows files immediately after. Web and docs app detect missing setup and guide the user.",
    "qualityGates": ["cd C:\\repos\\hq\\packages\\hq-cloud\\api && pnpm test", "cd C:\\repos\\hq\\packages\\hq-cli && pnpm test"],
    "repoPath": "C:\\repos\\hq",
    "relatedWorkers": ["dev-team/backend-dev", "dev-team/frontend-dev", "dev-team/qa-tester"],
    "knowledge": [
      "packages/hq-cloud/api/src/data/file-proxy.ts",
      "packages/hq-cloud/api/src/data/initial-sync.ts",
      "packages/hq-cloud/api/src/data/resolve-hq-dir.ts",
      "packages/hq-cloud/api/src/routes/files.ts",
      "packages/hq-cloud/api/src/routes/navigator.ts",
      "packages/hq-cli/src/commands/auth.ts",
      "packages/hq-cli/src/utils/sync.ts"
    ],
    "relatedProjects": ["hq-cloud", "hq-cloud-onboarding"]
  }
}
