worker:
  id: codex-debugger
  name: "Codex Debugger"
  description: "AI-powered debugging and root-cause analysis via OpenAI Codex SDK — diagnoses errors, identifies root causes, and generates fixes"
  type: CodeWorker
  version: "1.0"
  team: dev-team

execution:
  mode: on_demand
  max_runtime: 15m
  retry_attempts: 2
  spawn_method: task_tool
  model: haiku

context:
  base:
    - workers/public/dev-team/codex-debugger/skills/
    - knowledge/public/dev-team/patterns/
  dynamic:
    - pattern: "{target_repo}/src/"
      when: always
    - pattern: "{target_repo}/package.json"
      when: always
    - pattern: "{target_repo}/tsconfig.json"
      when: always
  exclude:
    - node_modules/
    - dist/
    - "*.log"
    - "*.lock"

skills:
  - id: debug-issue
    file: skills/debug-issue.md
  - id: root-cause-analysis
    file: skills/root-cause-analysis.md
  - id: fix-bug
    file: skills/fix-bug.md

verification:
  post_execute:
    - check: typescript
      command: npm run typecheck
    - check: lint
      command: npm run lint
    - check: test
      command: npm test
  approval_required: true
  human_checkpoints:
    - before_applying_fix
    - on_breaking_changes

mcp:
  server:
    command: node
    args: [../../codex-engine/dist/mcp-server.js]
    cwd: workers/public/dev-team/codex-debugger
  tools:
    - codex_debug
    - codex_generate

# State Machine (Loom pattern)
state_machine:
  enabled: true
  max_retries: 2
  hooks:
    post_execute:
      - auto_checkpoint
      - log_metrics
    on_error:
      - log_error
      - checkpoint_error_state

reporting:
  on_complete:
    - log_debug_session
    - extract_learnings
  metrics:
    - debug_time
    - root_cause_identified
    - fix_applied
    - back_pressure_pass_rate

instructions: |
  # Codex Debugger

  AI-powered debugging and root-cause analysis using OpenAI Codex SDK (gpt-5.1-codex-max) via the codex-engine MCP server.

  ## Primary Use Case

  Auto-invoked when back-pressure fails during pipeline execution. When codex-coder generates code that fails typecheck, lint, or tests, the pipeline escalates to codex-debugger to diagnose and fix the failure. Also available for standalone debugging of reported issues.

  ## When to Use

  - **debug-issue**: Accepts error output, diagnoses the issue, applies a fix, and re-runs back-pressure. Best for known errors with captured output.
  - **root-cause-analysis**: Analysis-only mode with no file changes. Best for understanding complex failures before deciding on a fix strategy.
  - **fix-bug**: Full diagnose-then-fix workflow. Best for reported bugs where you need both root-cause identification and implementation of the fix.

  Use codex-debugger when:
  - Back-pressure checks (typecheck/lint/test) fail after code generation
  - A specific error or bug needs diagnosis and repair
  - You need root-cause analysis before attempting a fix
  - Pipeline auto-escalation triggers after codex-coder iteration limits are exhausted

  Do NOT use codex-debugger when:
  - Task is new feature development (use codex-coder instead)
  - Task is a code review (use codex-reviewer instead)
  - Error is a known config issue (fix manually)

  ## Skills

  | Skill | Description |
  |-------|-------------|
  | debug-issue | Diagnose from error output via codex_debug, apply fix, run back-pressure |
  | root-cause-analysis | Analysis-only via codex_debug, return diagnosis without changes |
  | fix-bug | Full workflow: diagnose via codex_debug, implement fix via codex_generate, back-pressure loop |

  ## CLI Usage

  ```bash
  /run codex-debugger debug-issue --issue "TS2345 type error in auth middleware" --error-output "$(cat /tmp/typecheck-errors.txt)"
  /run codex-debugger root-cause-analysis --issue "Intermittent test failure in billing service"
  /run codex-debugger fix-bug --issue "User session not persisting after login" --cwd repos/private/{product}
  ```

  ## Patterns

  - Always capture full error output before invoking debug-issue
  - Use root-cause-analysis first when the issue is complex or unclear
  - fix-bug is the most comprehensive skill — use when you need end-to-end resolution
  - Back-pressure loop runs after every fix attempt (max 2 retries)
  - On back-pressure failure after retries, pause for human intervention
  - Preserve existing code patterns in target repo — fixes should match surrounding style

  ## Human-in-the-loop

  - Review diagnosis before applying any fix
  - Approve proposed fix when it touches multiple files
  - Intervene when back-pressure fails after max retries
