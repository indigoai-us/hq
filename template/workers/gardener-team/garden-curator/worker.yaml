worker:
  id: garden-curator
  name: "Garden Curator"
  description: "Execute approved garden actions â€” archive stale content, deduplicate, update INDEX, create escalation PRDs"
  type: OpsWorker
  version: "1.0"
  team: gardener-team

execution:
  mode: on_demand
  max_runtime: 30m
  retry_attempts: 1
  spawn_method: task_tool
  model: sonnet

context:
  base:
    - workers/public/gardener-team/garden-curator/skills/
    - companies/manifest.yaml
  dynamic:
    - pattern: "companies/{company}/"
      when: "task.has_company"
    - pattern: "workspace/orchestrator/garden-*/"
      when: always
    - pattern: "projects/"
      when: "task.has_escalations"
  exclude:
    - node_modules/
    - dist/
    - "*.log"
    - repos/

skills:
  - id: execute-actions
    file: skills/execute-actions.md

verification:
  post_execute:
    - check: actions_log_valid
      command: "node -e \"JSON.parse(require('fs').readFileSync(process.argv[1]))\""
  approval_required: true

state_machine:
  enabled: true
  max_retries: 1
  hooks:
    post_execute:
      - auto_checkpoint
      - log_metrics
    on_error:
      - log_error
      - checkpoint_error_state

reporting:
  on_complete:
    - log_actions_taken
  metrics:
    - files_archived
    - files_deduplicated
    - indexes_updated
    - prds_created
    - files_cleaned

instructions: |
  # Garden Curator

  You execute the approved actions from the audit report. You are the only gardener that modifies files.

  ## Role
  Take the audit-report.json, execute each approved action, and produce an actions-log.json recording what was done.

  ## Action Types
  - **ARCHIVE**: Move file to nearest `_archive/` dir with datestamp prefix. Remove from INDEX.md if listed.
  - **DEDUPLICATE**: Keep canonical file, delete duplicate. If duplicate is in a different knowledge base, leave a one-line note pointing to canonical.
  - **UPDATE**: Edit INDEX.md to match reality. For fact corrections, update the specific line/section.
  - **CLEAN**: Delete orphaned state files, old threads, empty dirs.
  - **ESCALATE**: Create draft PRD in `projects/garden-discovery-{slug}/` for needs-discovery items. Minimal PRD with one user story describing what needs validation.
  - **REASSIGN**: Move file to correct company directory per manifest. Update any INDEX.md affected.

  ## Rules
  - NEVER delete without archival (move to _archive/ first)
  - Knowledge repo files: changes must be committed to the TARGET repo (the symlink destination), not HQ git. Use `cd` to the target repo, `git add`, `git commit`.
  - HQ-native files (workspace/, projects/): commit to HQ git
  - Create _archive/ directories as needed (they're gitignored in knowledge repos, tracked in HQ)
  - When creating escalation PRDs, use minimal format:
    ```json
    {
      "name": "garden-discovery-{slug}",
      "description": "Validate conflicting information discovered by garden audit",
      "userStories": [{
        "id": "US-001",
        "title": "Resolve: {conflict description}",
        "description": "Garden audit found: {details}. Need to verify current state.",
        "acceptanceCriteria": ["Correct information identified", "Stale source archived or updated"],
        "priority": 2,
        "passes": false,
        "labels": ["garden-discovery"],
        "dependsOn": []
      }]
    }
    ```
  - Log every action taken with before/after state
  - If an action fails (file locked, permission denied), log the error and continue
