# HQ Cloud Session Runtime
# Runs Claude Code in WebSocket mode, connected to HQ Cloud API relay.
# User's HQ files are synced from S3 on startup.
#
# Required env vars at runtime:
#   ANTHROPIC_API_KEY, HQ_API_URL, SESSION_ID,
#   S3_BUCKET, S3_PREFIX, CLAUDE_CODE_SESSION_ACCESS_TOKEN
#
# Image target: < 1 GB  (node:20-slim ~200 MB, AWS CLI ~120 MB, Claude Code ~100 MB)

FROM public.ecr.aws/docker/library/node:20-slim

LABEL maintainer="HQ Cloud Team"
LABEL description="Claude Code session runtime for HQ Cloud"

# Install system dependencies (minimal â€” no build toolchain)
RUN apt-get update && apt-get install -y --no-install-recommends \
    git \
    curl \
    bash \
    jq \
    ca-certificates \
    procps \
    python3 \
    unzip \
    && rm -rf /var/lib/apt/lists/*

# Install AWS CLI v2 (for S3 sync)
RUN curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "/tmp/awscliv2.zip" \
    && unzip /tmp/awscliv2.zip -d /tmp \
    && /tmp/aws/install \
    && rm -rf /tmp/aws /tmp/awscliv2.zip

# Install Claude Code CLI globally
RUN npm install -g @anthropic-ai/claude-code \
    && npm cache clean --force

# Environment variables (set at runtime via ECS task definition)
ENV HQ_API_URL=""
ENV SESSION_ID=""
ENV USER_ID=""
ENV S3_BUCKET=""
ENV S3_PREFIX=""
ENV S3_REGION="us-east-1"
ENV CLAUDE_CODE_SESSION_ACCESS_TOKEN=""
ENV CLAUDE_CREDENTIALS_JSON=""
ENV NODE_ENV="production"
ENV HQ_ROOT="/hq"

# Create HQ directory
RUN mkdir -p /hq

# Copy entrypoint and health check scripts
COPY scripts/session-entrypoint.sh /usr/local/bin/session-entrypoint.sh
COPY scripts/session-healthcheck.sh /usr/local/bin/healthcheck.sh
RUN chmod +x /usr/local/bin/session-entrypoint.sh /usr/local/bin/healthcheck.sh

WORKDIR /hq

HEALTHCHECK --interval=30s --timeout=5s --start-period=60s --retries=3 \
    CMD /usr/local/bin/healthcheck.sh

ENTRYPOINT ["/usr/local/bin/session-entrypoint.sh"]
